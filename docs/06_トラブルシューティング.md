# 06. トラブルシューティング

> **対象**: エラーに遭遇した方  
> **所要時間**: 20分程度

## この章で学ぶこと

- よくあるエラーと対処法
- コンフリクトの解決方法
- 作業の一時保存と復元
- 緊急時の対処法

---

## 1. よくあるエラーと対処法

### エラー: `fatal: not a git repository`

**原因**: GitリポジトリでないフォルダでGitコマンドを実行

**対処法**:
```bash
# 正しいプロジェクトフォルダに移動
cd /path/to/your/project

# または、Gitリポジトリを初期化
git init
```

### エラー: `fatal: Authentication failed`

**原因**: GitHubの認証に失敗

**対処法**:
1. GitHubのユーザー名とパスワードを確認
2. パーソナルアクセストークンを使用
3. SSH認証の設定を確認

### エラー: `fatal: The current branch has no upstream branch`

**原因**: 新しいブランチを初回プッシュする時

**対処法**:
```bash
# 上流ブランチを設定してプッシュ
git push -u origin branch-name
```

### エラー: `Your local changes would be overwritten by merge`

**原因**: ローカルに未コミットの変更がある状態でプル

**対処法**:
```bash
# 変更を一時保存
git stash

# プルを実行
git pull origin main

# 保存した変更を復元
git stash pop
```

---

## 2. コンフリクトの解決

### コンフリクトとは

同じファイルの同じ行を複数人が変更した時に発生する競合

### コンフリクトの発生

```bash
# プル時にコンフリクトが発生
git pull origin main
```

**エラーメッセージ例**:
```
Auto-merging file.txt
CONFLICT (content): Merge conflict in file.txt
Automatic merge failed; fix conflicts and then commit the result.
```

### コンフリクトの解決手順

1. **コンフリクトファイルを開く**
2. **以下のマーカーを探す**:
   ```
   <<<<<<< HEAD
   あなたの変更
   =======
   他の人の変更
   >>>>>>> branch-name
   ```
3. **手動で編集して統合**
4. **マーカーを削除**
5. **解決完了をコミット**:
   ```bash
   git add .
   git commit -m "resolve: コンフリクトを解決"
   ```

### コンフリクト解決の例

**解決前**:
```javascript
function greet() {
<<<<<<< HEAD
  return "Hello, World!";
=======
  return "こんにちは、世界！";
>>>>>>> feature/japanese
}
```

**解決後**:
```javascript
function greet() {
  return "こんにちは、世界！";
}
```

---

## 3. 作業の一時保存（ステッシュ）

### ステッシュとは

作業中の変更を一時的に保存する機能

### ステッシュの使用

```bash
# 作業中の変更を一時保存
git stash

# 保存した変更を復元
git stash pop

# 保存した変更の一覧を確認
git stash list

# 特定のステッシュを復元
git stash apply stash@{0}
```

### 使用場面

- 作業途中で急に別のブランチに切り替えたい
- 他のメンバーの変更を確認したい
- 緊急の修正が必要になった

---

## 4. 変更の取り消し

### ステージングの取り消し

```bash
# ステージングした変更を取り消し（箱から出す）
git reset HEAD filename.txt

# または（新しい書き方）
git restore --staged filename.txt
```

### 未ステージングの変更を破棄

```bash
# 未ステージングの変更を破棄
git restore filename.txt

# または
git checkout -- filename.txt
```

### 直前のコミットの修正

```bash
# 直前のコミットメッセージを修正
git commit --amend -m "新しいメッセージ"

# 直前のコミットに変更を追加
git add .
git commit --amend --no-edit
```

**注意**: プッシュ前のみ使用可能

---

## 5. コミット履歴の操作

### コミット履歴の確認

```bash
# コミット履歴を確認
git log

# 簡潔な履歴を確認
git log --oneline

# 特定のファイルの履歴を確認
git log -- filename.txt
```

### 過去のコミットに戻る

```bash
# 特定のコミットを確認（一時的、デタッチドヘッド状態）
git checkout <commit-hash>

# 元のブランチに戻る
git checkout main
```

### 過去のコミットから新しいブランチを作成

```bash
# 特定のコミットから新しいブランチを作成
git checkout -b new-branch-name <commit-hash>

# または（新しい書き方）
git switch -c new-branch-name <commit-hash>
```

---

## 6. 緊急時の対処法

### 間違ったブランチで作業してしまった

```bash
# 現在の変更をステッシュ
git stash

# 正しいブランチに切り替え
git checkout correct-branch

# 変更を復元
git stash pop
```

### 間違ったファイルをコミットしてしまった

```bash
# 直前のコミットを取り消し（変更は保持）
git reset --soft HEAD~1

# 不要なファイルをステージングから除外
git reset HEAD unwanted-file.txt

# 再度コミット
git commit -m "正しいコミットメッセージ"
```

### プッシュしてしまった間違ったコミット

```bash
# 新しいコミットで修正
git revert HEAD

# プッシュ
git push origin main
```

---

## 7. リモートリポジトリの問題

### リモートURLが間違っている

```bash
# 現在のリモートURLを確認
git remote -v

# リモートURLを変更
git remote set-url origin https://github.com/username/correct-repo.git
```

### リモートブランチが削除された

```bash
# リモートの削除されたブランチをローカルから削除
git remote prune origin

# または
git fetch --prune
```

---

## 8. パフォーマンスの問題

### リポジトリが重い

```bash
# 浅いクローンを使用
git clone --depth 1 https://github.com/username/repo.git

# 後で完全な履歴を取得
git fetch --unshallow
```

### 大きなファイルの削除

```bash
# ファイルを履歴から完全に削除
git filter-branch --force --index-filter \
  'git rm --cached --ignore-unmatch large-file.txt' \
  --prune-empty --tag-name-filter cat -- --all
```

---

## 9. 予防策

### 定期的な同期

```bash
# 定期的に最新の変更を取得
git pull origin main
```

### 小さなコミット

```bash
# 機能単位で小さくコミット
git add feature1/
git commit -m "feat: 機能1を実装"

git add feature2/
git commit -m "feat: 機能2を実装"
```

### ブランチの整理

```bash
# 不要なブランチを定期的に削除
git branch -d old-feature-branch
git push origin --delete old-feature-branch
```

---

## 10. 次のステップ

トラブルシューティングをマスターしたら、以下を学習してください：

- [07_練習問題.md](07_練習問題.md) - 実践練習
- [GitHub_チーム開発スキル_学習ガイド（全体版）.md](GitHub_チーム開発スキル_学習ガイド（全体版）.md) - 詳細な参考資料

---

## よくある質問

### Q: コンフリクトが解決できません
A: チームメンバーに相談するか、該当ファイルを削除して再作成する方法もあります。

### Q: ステッシュした変更を忘れました
A: `git stash list`で確認し、`git stash apply stash@{番号}`で復元できます。

### Q: 間違ったブランチにプッシュしてしまいました
A: 新しいコミットで修正するか、チームメンバーに相談してください。

### Q: リポジトリが壊れてしまいました
A: バックアップから復元するか、チームメンバーに相談してください。多くの場合、`git reset`や`git reflog`で復旧可能です。
